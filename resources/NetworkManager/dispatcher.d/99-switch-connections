#!/bin/bash

INTERFACE="eth0"
LAN_PROFILE="lan-connection"
PC_PROFILE="direct-connection"
DIRECT_IP="192.168.44.1"
LOGFILE="/var/log/nm-dispatch.log"

log() {
    /bin/echo "$(/bin/date) - $1" >> $LOGFILE
}

check_active_profile() {
    /usr/bin/nmcli -t -f NAME connection show --active | /bin/grep -q "$1"
}

bring_down_profile() {
    log "Bringing down profile $1"
    /usr/bin/nmcli connection down "$1"
}

bring_up_profile() {
    log "Bringing up profile $1"
    /usr/bin/nmcli connection up "$1"
}

get_current_ip() {
    /usr/sbin/ip addr show $INTERFACE | /bin/grep 'inet ' | /usr/bin/awk '{print $2}' | /usr/bin/cut -d/ -f1
}

ensure_interface_up() {
    log "Ensuring interface $INTERFACE is up."
    /usr/bin/nmcli device set $INTERFACE managed yes
    /usr/bin/nmcli device connect $INTERFACE
}

case "$1" in
    $INTERFACE)
        case "$2" in
            up)
                log "$INTERFACE is up."
                CURRENT_IP=$(get_current_ip)
                log "Current IP: $CURRENT_IP"
                if [ "$CURRENT_IP" = "$DIRECT_IP" ]; then
                    log "Direct connection IP detected. Ensuring Direct PC profile is active."
                    if ! check_active_profile "$PC_PROFILE"; then
                        bring_down_profile "$LAN_PROFILE"
                        bring_up_profile "$PC_PROFILE"
                    fi
                else
                    log "No direct connection IP detected. Ensuring LAN profile is active."
                    if ! check_active_profile "$LAN_PROFILE"; then
                        bring_down_profile "$PC_PROFILE"
                        bring_up_profile "$LAN_PROFILE"
                    fi
                fi
                ;;
            down)
                log "$INTERFACE is down."
                ensure_interface_up
                ;;
            pre-up)
                log "$INTERFACE is pre-up."
                CURRENT_IP=$(get_current_ip)
                log "Current IP: $CURRENT_IP"
                if [ "$CURRENT_IP" = "$DIRECT_IP" ]; then
                    log "Direct connection IP detected. Ensuring Direct PC profile is active."
                    if ! check_active_profile "$PC_PROFILE"; then
                        bring_down_profile "$LAN_PROFILE"
                        bring_up_profile "$PC_PROFILE"
                    fi
                else
                    log "No direct connection IP detected. Ensuring LAN profile is active."
                    if ! check_active_profile "$LAN_PROFILE"; then
                        bring_down_profile "$PC_PROFILE"
                        bring_up_profile "$LAN_PROFILE"
                    fi
                fi
                ;;
            connection-failed)
                log "Connection failed for $INTERFACE."
                CURRENT_IP=$(get_current_ip)
                log "Current IP: $CURRENT_IP"
                if [ "$CURRENT_IP" != "$DIRECT_IP" ]; then
                    log "Switching to Direct PC profile."
                    bring_down_profile "$LAN_PROFILE"
                    bring_up_profile "$PC_PROFILE"
                else
                    log "Direct connection failed. Retrying LAN profile."
                    bring_down_profile "$PC_PROFILE"
                    bring_up_profile "$LAN_PROFILE"
                fi
                ;;
            *)
                log "Unhandled event: $2"
                ;;
        esac
        ;;
    *)
        log "Unhandled interface: $1"
        ;;
esac
